name: macOS Release
on:
  push:
    branches:
      - main
jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get latest tag
        id: tag
        run: |
          git fetch --tags
          TAG=$(git describe --tags --abbrev=0 || echo "v0.0.0")
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      - name: Bump patch version
        id: version
        run: |
          VERSION=${{ steps.tag.outputs.tag }}
          VERSION=${VERSION#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          PATCH=$((PATCH+1))
          NEW="v$MAJOR.$MINOR.$PATCH"
          echo "version=$NEW" >> $GITHUB_OUTPUT
      - name: Create Git tag
        run: |
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}
      - name: Build macOS app
        run: |
          xcodebuild \
            -project "Clipboard Manager.xcodeproj" \
            -scheme "Clipboard Manager" \
            -configuration Release \
            -derivedDataPath build \
            clean build
      - name: Verify build output
        run: |
          echo "Contents of build directory:"
          find build -name "*.app" -type d
          ls -la build/Build/Products/Release/ || echo "Release directory not found"
      - name: Copy app to expected location
        run: |
          mkdir -p "build/Release"
          cp -R build/Build/Products/Release/*.app "build/Release/"
      - name: Install create-dmg
        run: brew install create-dmg
      - name: Build DMG
        run: ./scripts/build_dmg.sh
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          files: build/dmg/*.dmg
          generate_release_notes: true
      - name: Generate appcast.xml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_URL="https://github.com/Bashamega/clipboard-manager/releases/download/$VERSION/Clipboard.Manager.dmg"
          cat > appcast.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
            <channel>
              <title>Clipboard Manager Updates</title>
              <item>
                <title>Version ${VERSION}</title>
                <sparkle:version>${VERSION}</sparkle:version>
                <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                <enclosure
                  url="${DMG_URL}"
                  sparkle:os="macos"
                  length="0"
                  type="application/octet-stream"/>
              </item>
            </channel>
          </rss>
          EOF
      - name: Commit appcast.xml if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          if ! git diff --cached --quiet; then
            git commit -m "chore(release): update appcast.xml for ${{ steps.version.outputs.version }}"
            git push origin main
          else
            echo "No changes to appcast.xml, skipping commit."
          fi
